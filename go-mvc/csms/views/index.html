<!DOCTYPE html>
<html class="xa-page" lang="zh-CN">
<head>
<!-- <base href="http://127.0.0.1:3000/"> -->
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="renderer" content="webkit" />
<meta name="force-rendering" content="webkit" />
<meta name="google" value="notranslate" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<meta name="robots" content="noindex,nofollow" />
<meta
  name="viewport"
  content="width=device-width,initial-scale=1,shrink-to-fit=no"
/>
<title>api 接口测试</title>
<meta name="keywords" content="" />
<meta name="description" content="" />
<link rel="stylesheet" type="text/css" href="assets/vendors/bootstrap/bootstrap.min.css" />
</head>
<body>
</br>
</br>
<h2>1.登录</h2>
<input type="text" name="Name" value="root"></br>
<input type="text" name="Password" value="123456"></br>
<button type="button" id="js-submit">登录</button></br></br></br>

</br>
</br>
<h2>2.获取数据</h2>
<button id="js-list">获取</button>
<button id="js-add">添加</button>

<table class="table">
<thead>
<tr>
  <th>ID</th>
  <th>姓名</th>
  <th>邮箱</th>
  <th>手机号</th>
  <th>时间</th>
  <th>操作</th>
</tr>
</thead>
<tbody class="js-list-tbody">
<tr data-id="2">
  <th scope="row"></th>
  <td></td>
  <td></td>
  <td></td>
  <td></td>
  <td>
    <button type="button" id="js-edit">查看</button>
    <button type="button" id="js-delete">删除</button>
  </td>
</tr>
</tbody>
</table>

<script src="assets/vendors/jquery/3.3.1/dist/jquery.min.js"></script>
<script src="assets/vendors/bootstrap/bootstrap.min.js"></script>
<script src="assets/vendors/storejs/dist/store.min.js"></script>
<script>
$(function(){

  // 1.登录
  $("#js-submit").on("click", function(){

    let user = {
      Name: '刘备',
      Password: '123456'
    }

    $.ajax({
      type: "post",
      url: "http://127.0.0.1:3000/user/login",
      async:  true,
      data: JSON.stringify(user),
      cache: false,
      dataType: "json",
      success: function(res) { 
        console.log(res)
        store.set("auth-token", res.data.token)
      },
      error: function(e) {
        console.log(e)
      }
    });
  });

  // 2.获取数据
  $("#js-list").on("click", function(){

    let query = {
      pageNumber: 1,
      pageSize: 5,
      username: '张小帅',
    }

    const params = Object.keys(query)
      .map(key => query[key] && `${encodeURIComponent(key)}=${encodeURIComponent(query[key])}`)
      .join('&');

    console.log(params)  


    $.ajax({
      type: "get",
      url: "http://127.0.0.1:3000/user/list?"+ params,
      async:  true,
      cache: false,
      dataType: "json",
      success: function(res) {     
        console.log(res)
        let tpl = ''
        for (const item of res.data.rows) {
          tpl +=  `<tr data-id="${item.id}">
            <th scope="row">${item.id}</th>
            <td>${item.username}</td>
            <td>${item.email}</td>
            <td>${item.mobile}</td>
            <td>${item.createTime}</td>
            <td>
              <button type="button" id="js-edit">查看</button>
              <button type="button" id="js-delete">删除</button>
            </td>
          </tr>`
        }
        $('.js-list-tbody').html(tpl)
      },
      error: function(e) {
        console.log(e)
      },
      beforeSend: function(request) {
        request.setRequestHeader("Authorization", "bearer "+store.get("auth-token"));
      }
    });
  });

  // 3.添加数据
  $("#js-add").on("click", function(){

    let user = {
      RoleId: 2,
      Name: '张小帅777',
      Password: 'admin333',
      Email: '777@sohu.com',
      Mobile: '13888555777',
      IsSuper: 1,
      Status: 1,
    }

    $.ajax({
      type: "post",
      url: "http://127.0.0.1:3000/user/save",
      async:  true,
      data: JSON.stringify(user),
      cache: false,
      dataType: "json",
      success: function(res) {    
        console.log(res)
      },
      error: function(e) {
        console.log(e)
      },
      beforeSend: function(request) {
        request.setRequestHeader("Authorization", "bearer "+store.get("auth-token"));
      }
    });
  });

  // 4.查看数据
  $('.js-list-tbody').on('click', '#js-edit', function(){
    const id = $(this).parents('tr').attr('data-id')
    $.ajax({
      type: "get",
      url: "http://127.0.0.1:3000/user/item?id=" + id,
      async:  true,
      cache: false,
      dataType: "json",
      success: function(res) {     
        console.log(res.data)
      },
      error: function(e) {
        console.log(e)
      },
      beforeSend: function(request) {
        request.setRequestHeader("Authorization", "bearer "+store.get("auth-token"));
      }
    });
  });

  // 5.删除数据
  $('.js-list-tbody').on('click', '#js-delete', function(){
    const id = $(this).parents('tr').attr('data-id')
    let user = {
      Id: parseInt(id)
    }
    console.log(user)
    $.ajax({
      type: "post",
      url: "http://127.0.0.1:3000/user/delete",
      async:  true,
      data: JSON.stringify(user),
      cache: false,
      dataType: "json",
      success: function(data) {     
        console.log(data)
      },
      error: function(e) {
        console.log(e)
      },
      beforeSend: function(request) {
        request.setRequestHeader("Authorization", "bearer "+store.get("auth-token"));
      }
    });
  });
})
</script>
</body>
</html>
